package com.jym.patpat;

import java.io.File;
import java.util.Hashtable;

import com.jym.helper.TextPref;

import android.app.Application;
import android.appwidget.AppWidgetManager;
import android.content.ComponentName;
import android.content.Context;
import android.content.Intent;
import android.content.res.Configuration;
import android.os.Environment;
import android.util.DisplayMetrics;
import android.util.Log;
import android.view.WindowManager;

public class PatpatWidgetApp extends Application {
	
	
	//Init pref files at application class
	static String parentPath = Environment.getExternalStorageDirectory().getAbsolutePath()+ "SsdamSsdam" ;
	File saveDir ;
	
	//service Switch for onetime run service
	public static TextPref mPref;	
	boolean serviceSwitch;
	
	private static PatpatWidgetApp self;
	private static Hashtable<Integer, PatpatView> views = new Hashtable<Integer, PatpatView>();
	private static DisplayMetrics metrics;

	@Override
	public void onConfigurationChanged(Configuration newConfig) {
		// TODO Auto-generated method stub
		super.onConfigurationChanged(newConfig);
		
		
	}

	@Override
	public void onCreate() {
		// TODO Auto-generated method stub
		super.onCreate();
		self = this;
		Log.d("addClickIntent", "Application create");
		WindowManager wm = (WindowManager)getSystemService(Context.WINDOW_SERVICE);
		metrics = new DisplayMetrics();
		wm.getDefaultDisplay().getMetrics(metrics);
		UpdateAllWidgets();
		
		
		
		
		Log.d("serviceSwitch", "parentPath : "+parentPath);
		
		// Init pref files at application class
		saveDir = new File(parentPath); // dir : 생성하고자 하는 경로
		Log.d("serviceSwitch","new File");
		if (!saveDir.exists()) {
			Log.d("serviceSwitch","aveDir.exists()");
			saveDir.mkdirs();
		}

		
		Log.d("serviceSwitch","End File");
		try {
			mPref = new TextPref("mnt/sdcard/SsdamSsdam/textpref.pref");

		} catch (Exception e) {
			e.printStackTrace();
		}   
		
		Log.d("serviceSwitch","e :"+e);
		mPref.Ready();
		Log.d("serviceSwitch","mPref.Ready();");
		serviceSwitch = mPref.ReadBoolean("serviceSwitch", true);
		
		
		if(serviceSwitch){
		Intent intent = new Intent("com.jym.service.IntentService_DeviceEvents");
		this.startService(intent);
		
		mPref.WriteBoolean("serviceSwitch", false);
		mPref.CommitWrite();
		mPref.EndReady();
		}
		
		
	}

	public void UpdateAllWidgets() {
		Log.d("addClickIntent", "UpdateAllWidgets");
		AppWidgetManager man = AppWidgetManager.getInstance(getApplication());
		views.clear();
		int[] ids = man.getAppWidgetIds(new ComponentName(getApplication(), PatpatWidgetProvider.class));
		for (int x : ids) {
			UpdateWidget(x);
		}
	}

	public void UpdateWidget(int widgetId) {
		if (!views.containsKey(widgetId)) {
			PatpatView view = new PatpatView(this, widgetId);
			views.put(widgetId, view);
		}
	}

	public void DeleteWidget(int widgetId) {
		if(views.containsKey(widgetId))
		{
			views.remove(widgetId);
		}
	}

	public PatpatView GetView(int widgetId) {
		
		Log.d("CoinBlockWidgetApp", "GetView, widgetId is = "+widgetId);
		
		
		if (!views.containsKey(widgetId)) {
			PatpatView view = new PatpatView(this, widgetId);
			views.put(widgetId, view);
		}
		return views.get(widgetId);
	}

	public static Context getApplication() {
		return self;
	}

	public static DisplayMetrics getMetrics() {
		return metrics;
	}
}